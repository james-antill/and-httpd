#! /usr/bin/python -tt

import md5
import sys
import os
import time

fname_w = sys.argv.pop(1)
fname_r = sys.argv.pop(1)

def read(f):
    """ Fix the python file.read() function. """
    data = f.read(1024 * 4)
    while data:
        yield data
        data = f.read(1024 * 4)

def argv2md5():
    try:
        fname_md5 = sys.argv.pop(1)
        out = md5.new()
        for block in read(open(fname_md5)):
            out.update(block)
        out = out.hexdigest()
    except:
        out = None
    return out

out     = argv2md5()
out_gz  = argv2md5()
out_bz2 = argv2md5()

conf = open(fname_r).read()
f = open(fname_w, 'w')
f.write(conf)
f.write("\n")
# Assume no embeded \n's
f.write(";; AUTO Generated by %s -- at <%s> ;;\n" %
        (os.path.basename(sys.argv[0]), time.asctime()))

f.write("(org.and.httpd-conf-req-1.0 ")

if out is not None:
    f.write("\n   Content-MD5:       %s" % out)

if out_gz is not None:
    f.write("\n   gzip/Content-MD5:  %s" % out_gz)

if out_bz2 is not None:
    f.write("\n   bzip2/Content-MD5: %s" % out_bz2)

f.write(")\n")
f.close()
